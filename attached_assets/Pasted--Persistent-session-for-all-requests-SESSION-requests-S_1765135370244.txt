# === Persistent session for all requests ===
SESSION = requests.Session()
SESSION.headers.update({
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/122.0.0.0 Safari/537.36"
})

# === Failed site cache ===
FAILED_SITES = {}  # {url: failure_time}
FAILURE_COOLDOWN_MINUTES = 3

def is_site_in_failure_cooldown(url):
    if url not in FAILED_SITES:
        return False
    if datetime.now() - FAILED_SITES[url] < timedelta(minutes=FAILURE_COOLDOWN_MINUTES):
        return True
    del FAILED_SITES[url]
    return False

def mark_site_failed(url):
    FAILED_SITES[url] = datetime.now()

# === JS-only page skip cache ===
JS_SKIP_CACHE = {}  # {url: skip_until_time}
JS_SKIP_MINUTES = 5

def is_in_js_skip_cache(url):
    if url not in JS_SKIP_CACHE:
        return False
    if datetime.now() < JS_SKIP_CACHE[url]:
        return True
    del JS_SKIP_CACHE[url]
    return False

def add_to_js_skip_cache(url):
    JS_SKIP_CACHE[url] = datetime.now() + timedelta(minutes=JS_SKIP_MINUTES)

# === Timeout per URL ===
def get_timeout_for_url(url):
    slow_sites = ["very.co.uk", "game.co.uk", "johnlewis.com", "argos.co.uk"]
    if any(site in url for site in slow_sites):
        return 30
    return 15

# === Batch insert/update for PostgreSQL ===
from psycopg2.extras import execute_values

def save_state(state):
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        batch = [
            (store_url, product_url, data.get("name"), data.get("in_stock", True))
            for store_url, products in state.items()
            for product_url, data in products.items()
        ]
        if batch:
            execute_values(cur, """
                INSERT INTO product_state (store_url, product_url, product_name, in_stock, last_seen)
                VALUES %s
                ON CONFLICT (store_url, product_url) 
                DO UPDATE SET product_name = EXCLUDED.product_name, 
                              in_stock = EXCLUDED.in_stock,
                              last_seen = CURRENT_TIMESTAMP
            """, batch)
            conn.commit()
        cur.close()
        conn.close()
    except Exception as e:
        print(f"⚠️ Error saving state: {e}")
